openapi: '3.0.2'
info:
  title: API THEye
  version: '0.7.0-alpha'
servers:
  - url: https://backend.theye.ch/api/v0

components:
  schemas:
    api-version:
      type: object
      properties:
        api_version:
          type: string
          format: semantic version number
          example: '1.2.3'
    detail:
      type: object
      properties:
        detail:
          type: string
          format: string
          example: Lorem ipsum. 
    device:
      type: object
      properties:
        id:
          type: string 
          format: hexadecimal
          maxLength: 12 
          minLength: 12 
          example: 0123456789AB 
          readOnly: true
        creation_date:
          type: string
          format: iso-8601
          example: 2021-01-18T16:32:10.000000Z
          readOnly: true
        modification_date:
          type: string
          format: iso-8601
          example: 2021-01-18T16:32:10.000000Z
          readOnly: true
        name:
          type: string
          example: Device A
        owner:
          type: integer 
          example: 1 
          readOnly: true
        is_active:
          type: boolean
          example: true
          readOnly: true
    devices:
      type: array
      items:
        $ref: '#/components/schemas/device'
    elog:
      type: object
      properties:
        device_id:
          type: string 
          format: hexadecimal
          maxLength: 12 
          minLength: 12 
          example: 0123456789AB 
        edata:
          type: string
          format: base64url 
          example: d3As065hUfzeLue21P69HxIix373+FLWtoMDru6PFdy9ZYLlD6yRuwEJCYAjhATu6LiJp340n7Imhhmmp5Xbm9ws7tKbGyGkxgG7GeJ8fak=
        hash:
          type: string 
          format: hexadecimal
          maxLength: 64 
          minLength: 64 
          example: 00112233445566778899AABBCCDDEEFF00112233445566778899AABBCCDDEEFF 
        initialization_vector:
          type: string 
          format: hexadecimal
          maxLength: 32 
          minLength: 32 
          example: 00112233445566778899AABBCCDDEEFF 
        key_id:
          type: integer 
          example: 314 
    lock-code:
      type: object
      properties:
        key_id:
          type: integer
          example: 314 
        lock_code: 
          type: string 
          format: hexadecimal
          maxLength: 16 
          minLength: 16 
          example: 0123456789ABCDEF
    lock-token:
      type: object
      properties:
        device_id:
          type: string 
          format: hexadecimal
          maxLength: 12 
          minLength: 12 
          example: 0123456789AB 
          readOnly: true
        lock_token: 
          type: string
          format: hexadecimal
          maxLength: 48 
          minLength: 48 
          example: 00112233445566778899AABBCCDDEEFF0123456789ABCDEF
          readOnly: true
    log:
      type: object
      properties:
        device_id:
          type: string
          format: hex48 
          example: 0123456789AB 
        points:
          type: array
          items: 
            $ref: '#/components/schemas/point'
          example:
            - i : 10
              t : 225
              h : 452
            - i : 70
              t : 245
              h : 462
    ownership-code:
      type: object
      properties:
        code: 
          type: string 
          format: hexadecimal
          maxLength: 32 
          minLength: 32 
          example: 00112233445566778899AABBCCDDEEFF 
          readOnly: true
        expires:
          type: string
          format: iso-8601
          example: 2021-01-18T16:32:10.000000Z
          readOnly: true
    ownership-token:
      type: object
      properties:
        key_id: 
          type: integer
          example: 314 
        ownership_token:
          type: string
          format: hexadecimal
          maxLength: 32 
          minLength: 32 
          example: 00112233445566778899AABBCCDDEEFF
    password:
      type: object
      properties:
        password:
          type: string
          example: SecretPa55word 
        new_password:
          type: string
          example: NewSecretPa55word 
    point:
      type: object
      properties:
        i:
          description: Time Id of the point (to be defined)
          type: integer 
          example: 10 
        t:
          description: Temperature of the point (in 0.01 [Â°C]) 
          type: integer 
          example: 225 
        h:
          description: Humidity of the point (in 0.01 [%]) 
          type: integer 
          example: 452 
    profile:
      type: object
      properties:
        id:
          type: integer
          example: 314
          readOnly: True
        first_name:
          type: string
          example: Alice
        last_name:
          type: string
          example: Wonderland
        email:
          type: string
          format:  email
          example: alice.wonderland@mail.com

  securitySchemes:
    theye_oauth:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: 'https://backend.theye.ch/o/authorize'
          tokenUrl: 'https://backend.theye.ch/o/token'
          scopes:
            'openid': OpenId Connect scope
            'read': Can read 
            'write': Can write 
    theye_oidc:
      type: openIdConnect
      openIdConnectUrl: 'https://backend.theye.ch/o/.well-known/openid-configuration'

paths:
  /:
    get:
      description: Get THEye API version. 
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/api-version'
  /devices/:
    get:
      description: Get all devices of the user.
      security:
        - theye_oauth:
          - read 
      responses:
        '200': 
          description: OK
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/devices' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden (user is inactive). 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
  /devices/{device-id}/:
    get:
      description: Get device.
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      security:
        - theye_oauth:
          - read 
      responses:
        '200': 
          description: OK
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/device' 
        '401':
          description: Unauthorized. 
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '404':
          description: Not found. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
    put:
      description: Put device.
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      requestBody:
        description: Data of the device to update
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/device' 
      security:
        - theye_oauth:
          - write 
      responses:
        '200': 
          description: Ok, device updated 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '400':
          description: Bad request, data format error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '404':
          description: Not found. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 

  /devices/{device-id}/compute-lock-token:
    put:
      description: Compute and get the device lock token.
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      requestBody:
        description: Lock Code 
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/lock-code' 
      security:
        - theye_oauth:
          - read 
      responses:
        '200': 
          description: Ok, lock-token delivered.  
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/lock-token' 
        '400':
          description: Bad request, data format error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '500':
          description: Internal server error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
  /devices/{deviceID}/log/:
    get:
      description: Get log of the device
      security:
        - theye_oauth:
          - read 
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/log'
        '404':
          description: Not Found
  /devices/{device-id}/own:
     put:
      description: Own the device.
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      requestBody:
        description: Owneship token 
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/ownership-token' 
      security:
        - theye_oauth:
          - write 
      responses:
        '200': 
          description: Ok, ownership granted. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '201': 
          description: Ok, ownership granted. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '400':
          description: Bad request, data format error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '500':
          description: Internal server error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
  /devices/{device-id}/release:
     put:
      description: Release ownership of the device.
      parameters:
        - name: device-id
          in: path
          required: true
          schema:
            type: string 
            format: hexadecimal
            maxLength: 12 
            minLength: 12 
            example: 0123456789AB 
      security:
        - theye_oauth:
          - write 
      responses:
        '200': 
          description: Ok, ownership released. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '400':
          description: Bad request, data format error. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
        '404':
          description: Not found. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
  /elog/:
    put:
      description: Put encrypted log
      requestBody:
        description: Encrypted data 
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/elog' 
      responses:
        '200':
          description: OK
        '400':
          description: Request is invalid.
        '403':
          description: Forbidden
        '404':
          description: Not Found
        '406':
          description: Data are corrupted or do not belong to the device
        '500':
          description: Data processing error
  /ownership-code/: 
    post:
      description: Create and get an ownership code. 
      security:
        - theye_oauth:
          - write 
      responses:
        '201': 
          description: Ok, ownership released. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/ownership-code' 
        '401':
          description: Unauthorized.
        '403':
          description: Forbidden. 
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 
  /profile/:
    get:
      description: Get user profile.
      security:
        - theye_oauth:
          - read 
      responses:
        '200':
          description: OK
        '401':
          description: Unauthorized 
    put:
      description: Update the user profile.
      security:
        - theye_oauth:
          - write 
      requestBody:
        description: Data of the profile to update
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/profile' 
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/profile' 
        '401':
          description: Unauthorized 
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 

  /profile/password/:
    put:
      description: Update the user password. 
      security:
        - theye_oauth:
          - write
      requestBody:
        description: Passwords 
        required: true
        content:
          application/json:
            schema:
              $ref : '#/components/schemas/password' 
      responses:
        '200':
          description: OK
        '401':
          description: Unauthorized 
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref : '#/components/schemas/detail' 